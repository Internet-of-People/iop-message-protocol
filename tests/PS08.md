### PS08xxx - Neighborhood Related Functionality Tests

#### PS08001 - Neighborhood Related Calls - Unauthorized

##### Prerequisites/Inputs

###### Inputs:
  * Server's IP address
  * Server's srNeighbor port

##### Description 

The test sends *StartNeighborhoodInitializationRequest*, *FinishNeighborhoodInitializationRequest*, *NeighborhoodSharedProfileUpdateRequest*,
*StopNeighborhoodUpdatesRequest* to the profile server without verifying its identity first.


###### Step 1:

The test connects to the srNeighbor port of the profile server and sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 1`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it sends *FinishNeighborhoodInitializationRequest*:

  * `Message.id := 2`

and reads the response. Then it sends *NeighborhoodSharedProfileUpdateRequest*:

  * `Message.id := 3`
  * `NeighborhoodSharedProfileUpdateRequest.items = []`

and reads the response. Then it sends *StopNeighborhoodUpdatesRequest*:

  * `Message.id := 4`

and reads the response.


##### Acceptance Criteria

###### Step 1:

Server replies with *Response*:
  
  * `Message.id == 1`
  * `Response.status == ERROR_UNAUTHORIZED`

Server replies with *Response*:
  
  * `Message.id == 2`
  * `Response.status == ERROR_UNAUTHORIZED`

Server replies with *Response*:
  
  * `Message.id == 3`
  * `Response.status == ERROR_UNAUTHORIZED`

Server replies with *Response*:
  
  * `Message.id == 4`
  * `Response.status == ERROR_UNAUTHORIZED`








#### PS08002 - Neighborhood Initialization Process - No Profiles

##### Prerequisites/Inputs
  * Server's database is empty.

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test starts the neighborhood initialization process with the profile server, which does not host any profiles.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port and connects 
to profile server's srNeighbor port and verifies its identity. 


###### Step 2:

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for *FinishNeighborhoodInitializationRequest* message:

  * `$Id := Message.Id`

and replies with *FinishNeighborhoodInitializationResponse*:

  * `Message.id := $Id`



##### Acceptance Criteria


###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully verifies its identity.


###### Step 2:

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends *FinishNeighborhoodInitializationRequest*.
  









#### PS08003 - Neighborhood Initialization Process - Small Set

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08003.jpg" file exists and contains JPEG image with size less than 20 kb

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test starts the neighborhood initialization process with a profile server, which hosts a small number of profiles.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates the following test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles:

  * $profileInfo1 is `version := [1,0,0], type := "Profile Type A", name := "Shanghai 1",   image := "images/PS08003.jpg", location := (31.23, 121.47),  extraData = null`
  * $profileInfo2 is `version := [1,0,0], type := "Profile Type A", name := "Mumbai 1",     image := "images/PS08003.jpg", location := (18.96, 72.82),   extraData = "t=running,Cycling,ice hockey,water polo"`
  * $profileInfo3 is `version := [1,0,0], type := "Profile Type A", name := "Karachi",      image := null,                 location := (24.86, 67.01),   extraData = "l=Karachi,PK;a=iop://185f8db32271fe25f561a6fc938b2e264306ec304eda518007d1764826381969;t=traveling,cycling,running"`
  * $profileInfo4 is `version := [1,0,0], type := "Profile Type B", name := "Buenos Aires", image := "images/PS08003.jpg", location := (-34.61, -58.37), extraData = null`
  * $profileInfo5 is `version := [1,0,0], type := "Profile Type B", name := "Shanghai 2",   image := null,                 location := (31.231, 121.47), extraData = "running"`
  * $profileInfo6 is `version := [1,0,0], type := "Profile Type C", name := "Mumbai 2",     image := "images/PS08003.jpg", location := (18.961, 72.82),  extraData = "MTg1ZjhkYjMyMjcxZmUyNWY1NjFhNmZjOTM4YjJlMjY0MzA2ZWMzMDRlZGE1MTgwMDdkMTc2NDgyNjM4MTk2OQ=="`
  * $profileInfo7 is `version := [1,0,0], type := "Profile Type C", name := "Mumbai 3",     image := null,                 location := (18.961, 72.82),  extraData = "t=running;l=Mumbai,IN"`


###### Step 2:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for *NeighborhoodSharedProfileUpdateRequest* message:

  * `$Id1 := Message.Id`

and replies with *NeighborhoodSharedProfileUpdateResponse*:

  * `Message.id := $Id1`

Then it waits for *FinishNeighborhoodInitializationRequest* message:

  * `$Id2 := Message.Id`

and replies with *FinishNeighborhoodInitializationResponse*:

  * `Message.id := $Id2`



##### Acceptance Criteria


###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends *NeighborhoodSharedProfileUpdateRequest*:

  * `NeighborhoodSharedProfileUpdateRequest.items == 
    (
      {ActionType = add, add {version, type, name, latitude, longitude, extraData match $profileInfo1; identityPublicKey is public key of test identity 1, setThumbnailImage == true, thumbnailImage != empty}},
      {ActionType = add, add {version, type, name, latitude, longitude, extraData match $profileInfo2; identityPublicKey is public key of test identity 2, setThumbnailImage == true, thumbnailImage != empty}},
      {ActionType = add, add {version, type, name, latitude, longitude, extraData match $profileInfo3; identityPublicKey is public key of test identity 3, setThumbnailImage == false, thumbnailImage == empty}},
      {ActionType = add, add {version, type, name, latitude, longitude, extraData match $profileInfo4; identityPublicKey is public key of test identity 4, setThumbnailImage == true, thumbnailImage != empty}},
      {ActionType = add, add {version, type, name, latitude, longitude, extraData match $profileInfo5; identityPublicKey is public key of test identity 5, setThumbnailImage == false, thumbnailImage == empty}},
      {ActionType = add, add {version, type, name, latitude, longitude, extraData match $profileInfo6; identityPublicKey is public key of test identity 6, setThumbnailImage == true, thumbnailImage != empty}},
      {ActionType = add, add {version, type, name, latitude, longitude, extraData match $profileInfo7; identityPublicKey is public key of test identity 7, setThumbnailImage == false, thumbnailImage == empty}},
    )`

Server sends *FinishNeighborhoodInitializationRequest*.
  

















#### PS08004 - Neighborhood Initialization Process - Large Set

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08004.jpg" file exists and contains JPEG image with size less than 20 kb

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test starts the neighborhood initialization process with a profile server, which hosts a large number of profiles.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 1000 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.


###### Step 2:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message.



##### Acceptance Criteria


###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.

Server sends *FinishNeighborhoodInitializationRequest*.


  







#### PS08005 - Neighborhood Updates

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08005.jpg" file exists and contains JPEG image with size less than 20 kb
  * "images/PS08005b.png" file exists and contains JPEG image with size less than 5 kb
  * "ps.pfx" file exists and contains a self-signed TLS certificate, not protected by password

###### Inputs:
  * Server's IP address
  * Server's primary port
  * Base port for simulated profile server


##### Description 

The test simulates a profile server instance and establishes a neighborhood relationship with the target profile server 
by invoking the neighborhood initialization process. The sets up identities on the target server and manipulates them 
in order to receive neighborhood updates from it. Then the test requests the profile server to stop sending updates 
and verifies that no more updates are sent. Finally, the test invokes the neighborhood initialization process again 
but does not complete it and verifies that no updates are coming.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 50 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.

The test then creates a server, on which it simulates part of the profile server behavior.
The simulated profile server uses the base port ($BasePort) as its primary port and $BasePort+1 as its srNeighbor port.


###### Step 2:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := $BasePort`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := $BasePort + 1`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message.


###### Step 3:

The test creates 15 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. Then it waits 20 seconds.


###### Step 4:

The test selects 15 existing identities and cancels their hosting agreements with the profile server. 
Then it waits 20 seconds.


###### Step 5:

The test selects 25 existing identities and changes their profile information on the profile server. 
Then it waits 20 seconds.


###### Step 6:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StopNeighborhoodUpdatesRequest*:

  * `Message.id := 3`

and reads the response.


###### Step 7:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 

The test selects 5 existing identities and cancels their hosting agreements with the profile server.

The test selects 5 existing identities and changes their profile on the profile server.

Then it waits 20 seconds.



###### Step 8:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := $BasePort`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := $BasePort + 1`
 
and reads the response. 


###### Step 9:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 


###### Step 10:

The test waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.


###### Step 11:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 


###### Step 12:

The test terminates the neighborhood initialization process by closing the connection.


###### Step 13:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 

Then it waits 20 seconds.




##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.

Server sends *FinishNeighborhoodInitializationRequest*.


###### Step 3:

The test successfully establishes hosting agreements for the new test identities.
The test successfully initializes all new profiles. 

The simulated profile server receives neighborhood updates in form of *NeighborhoodSharedProfileUpdateRequest* 
for all the newly hosted profiles on the target profile server.


###### Step 4:

The test successfully cancels the hosting agreements of the selected identities.

The simulated profile server receives neighborhood updates in form of *NeighborhoodSharedProfileUpdateRequest* 
for all the cancelled profiles on the target profile server.


###### Step 5:

The test successfully changes the profile information of the selected identities.

The simulated profile server receives neighborhood updates in form of *NeighborhoodSharedProfileUpdateRequest* 
for all the updated profiles on the target profile server.


###### Step 6:

Server replies with *StopNeighborhoodUpdatesResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`


###### Step 7:

The test successfully establishes hosting agreements for the new test identities.
The test successfully initializes all new profiles. 

The test successfully cancels the hosting agreements of the selected identities.

The test successfully changes the profile of the selected identities.

The simulated profile server does not receive any updates.


###### Step 8:

The the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`


###### Step 9:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 


###### Step 10:

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.


###### Step 11:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 


###### Step 12:

Nothing to check.

###### Step 13:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 

The simulated profile server does not receive any updates.




#### PS08006 - Neighborhood Initialization Process - Rejected

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08006.jpg" file exists and contains JPEG image with size less than 20 kb
  * max_follower_servers_count set to 1 in the configuration file

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test simulates a profile server instance and establishes a neighborhood relationship with the target profile server 
by invoking the neighborhood initialization process. It then simulates another profile server instance and tries to establish 
a neighborhood relationship with the target profile server, but this should fail as the target server only accepts 1 neighbor.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 10 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.


###### Step 2:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message. Then it closes the connection.


###### Step 3:

With another identity, the test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 2`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 2`
 
and reads the response. 



##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.

Server sends *FinishNeighborhoodInitializationRequest*.


###### Step 3:

Then the test successfully verifies its identity.

Server replies with *Response*:
  
  * `Message.id == 3`
  * `Response.status == ERROR_REJECTED`








#### PS08007 - Neighborhood Initialization Process - Already Exists

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08007.jpg" file exists and contains JPEG image with size less than 20 kb

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test simulates a profile server instance and establishes a neighborhood relationship with the target profile server 
by invoking the neighborhood initialization process. The test then tries to start the neighborhood initialization process 
again, which should fail.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 10 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.


###### Step 2:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message. Then it closes the connection.


###### Step 3:

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 2`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 2`
 
and reads the response. 



##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.

Server sends *FinishNeighborhoodInitializationRequest*.


###### Step 3:

Then the test successfully verifies its identity.

Server replies with *Response*:
  
  * `Message.id == 3`
  * `Response.status == ERROR_ALREADY_EXISTS`








#### PS08008 - Neighborhood Initialization Process - Busy

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08008.jpg" file exists and contains JPEG image with size less than 20 kb
  * neighborhood_initialization_parallelism set to 1 in the configuration file

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test simulates a profile server instance and establishes a neighborhood relationship with the target profile server 
by invoking the neighborhood initialization process, but not completing it. It then simulates another profile server instance 
and tries to establish a neighborhood relationship with the target profile server, but this should fail as the target 
server only allows 1 unfinished neighborhood initialization process at the time. The test then finishes the first initialization 
process and then retries the second one, which should succeed.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 10 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.


###### Step 2:

Using the first identity, the test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. 


###### Step 3:

Using the second identity, the test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 2`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 2`
 
and reads the response. 


###### Step 4:

Using the first identity, the test waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message. Then it closes the connection.


###### Step 5:

Using the second identity, the test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 2`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 2`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message. Then it closes the connection.


##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`


###### Step 3:

Then the test successfully verifies its identity.

Server replies with *Response*:
  
  * `Message.id == 3`
  * `Response.status == ERROR_BUSY`


###### Step 4:

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.

Server sends *FinishNeighborhoodInitializationRequest*.


###### Step 5:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.

Server sends *FinishNeighborhoodInitializationRequest*.













#### PS08009 - Neighborhood Initialization Process - Invalid Ports

##### Prerequisites/Inputs
  * Server's database is empty.

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test attempts to initiate neighborhood initialization processes with invalid values.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 0`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 4`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 0`
 
and reads the response. Then it sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 5`
  * `StartNeighborhoodInitializationRequest.primaryPort := 100000`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 6`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 100000`
 
and reads the response. 



##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 

Then the test successfully verifies its identity.

Server replies with *Response*:
  
  * `Message.id == 3`
  * `Response.status == ERROR_INVALID_VALUE`
  * `Response.details == "primaryPort"`


Server replies with *Response*:
  
  * `Message.id == 4`
  * `Response.status == ERROR_INVALID_VALUE`
  * `Response.details == "srNeighborPort"`


Server replies with *Response*:
  
  * `Message.id == 5`
  * `Response.status == ERROR_INVALID_VALUE`
  * `Response.details == "primaryPort"`


Server replies with *Response*:
  
  * `Message.id == 6`
  * `Response.status == ERROR_INVALID_VALUE`
  * `Response.details == "srNeighborPort"`







#### PS08010 - Neighborhood Initialization Process - Interrupted

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08010.jpg" file exists and contains JPEG image with size less than 20 kb
  * neighborhood_initialization_parallelism set to 1 in the configuration file

###### Inputs:
  * Server's IP address
  * Server's primary port


##### Description 

The test simulates a profile server instance and establishes a neighborhood relationship with the target profile server 
by invoking the neighborhood initialization process, but it fails to complete it and disconnects in the middle of the session.
Then it tries again and this time the process should complete. The setting of neighborhood_initialization_parallelism to 1 
should not affect the result and the server should not block the second attempt since the client disconnected and thus terminated
the first attempt.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 600 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.


###### Step 2:

The test then connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for the first *NeighborhoodSharedProfileUpdateRequest* message, 
to which it replies *NeighborhoodSharedProfileUpdateResponse* message, and then it waits for the second 
*NeighborhoodSharedProfileUpdateRequest* message and disconnects.


###### Step 3:

The test then connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := 1`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message. Then it closes the connection.



##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends two *NeighborhoodSharedProfileUpdateRequest* messages with information about some of the test identities.


###### Step 3:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`

Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about all test identities.

Server sends *FinishNeighborhoodInitializationRequest*.











#### PS08011 - Neighborhood Initialization Process - Updates Before Initialization Completes

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08011.jpg" file exists and contains JPEG image with size less than 20 kb
  * "ps.pfx" file exists and contains a self-signed TLS certificate, not protected by password

###### Inputs:
  * Server's IP address
  * Server's primary port
  * Base port for simulated profile server


##### Description 

The test simulates a profile server instance and establishes a neighborhood relationship with the target profile server 
by invoking the neighborhood initialization process. Before it completes the process, it creates new identities. 
This should result in update messages being sent after the initialization is finished.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 10 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.

The test then creates a server, on which it simulates part of the profile server behavior.
The simulated profile server uses the base port ($BasePort) as its primary port and $BasePort+1 as its srNeighbor port.

###### Step 2:

The test then connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := $BasePort`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := $BasePort + 1`
 
and reads the response. 


###### Step 3:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 


###### Step 4:

The test waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.


###### Step 5:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 


###### Step 6:

The test waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message. 


###### Step 7:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 

Then it waits 20 seconds.


##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`


###### Step 3:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 


###### Step 4:

The server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about hosted profiles.


###### Step 5:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 


###### Step 6:

Server sends *FinishNeighborhoodInitializationRequest*.


###### Step 7:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 

The simulated profile server received neighborhood updates in form of *NeighborhoodSharedProfileUpdateRequest* 
for all the new profiles registered on the target profile server. And together with the profiles received 
during the neighborhood initialization process, the test received information about all the test identities.













#### PS08012 - Neighborhood Initialization Process - Different Server Neighbor Port

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08012.jpg" file exists and contains JPEG image with size less than 20 kb
  * "ps.pfx" file exists and contains a self-signed TLS certificate, not protected by password

###### Inputs:
  * Server's IP address
  * Server's primary port
  * Base port for simulated profile server


##### Description 

The test simulates a profile server instance and establishes a neighborhood relationship with the target profile server 
by invoking the neighborhood initialization process. However, it claims different (invalid) srNeighbor port being used 
during the initialization process. This will cause problem to the target profile server when it attempts 
to deliver the neighborhood updates to the simulated server and it will have to fallback to the primary port 
to get information about the real srNeighbor port in use.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 10 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.

The test then creates a server, on which it simulates part of the profile server behavior.
The simulated profile server uses the base port ($BasePort) as its primary port and $BasePort+1 as its srNeighbor port.

###### Step 2:

The test then connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := $BasePort`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := 1`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message.


###### Step 3:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 

Then it waits up to 12 minutes while waiting for updates from the profile server.


##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`


Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about hosted profiles.

Server sends *FinishNeighborhoodInitializationRequest*.


###### Step 3:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 

The simulated profile server received neighborhood updates in form of *NeighborhoodSharedProfileUpdateRequest* 
for all the new profiles registered on the target profile server. 














#### PS08013 - Neighborhood Initialization Process - Bad Role Server Neighbor Port

##### Prerequisites/Inputs
  * Server's database is empty.
  * "images/PS08013.jpg" file exists and contains JPEG image with size less than 20 kb
  * "ps.pfx" file exists and contains a self-signed TLS certificate, not protected by password

###### Inputs:
  * Server's IP address
  * Server's primary port
  * Base port for simulated profile server


##### Description 

The test does exactly the same as in PS08012 except that the claimed srNeighbor port in use is actually its clNonCustomer port.
which it runs on port $BasePort + 2, and therefore the profile server will get ERROR_BAD_ROLE statuses on its neighborhood related requests.


###### Step 1:

The tests obtains a list of service ports from the profile server's primary port.

The test creates a primary identity which it uses to simulate another profile server and then 
it creates 10 test identities, establishes hosting agreements with the profile server for them, 
and initializes their profiles.

The test then creates a server, on which it simulates part of the profile server behavior.
The simulated profile server uses the base port ($BasePort) as its primary port and $BasePort+1 as its srNeighbor port.

###### Step 2:

The test then connects to profile server's srNeighbor port and verifies its identity. 

The test sends *StartNeighborhoodInitializationRequest*:

  * `Message.id := 3`
  * `StartNeighborhoodInitializationRequest.primaryPort := $BasePort`
  * `StartNeighborhoodInitializationRequest.srNeighborPort := $BasePort + 2`
 
and reads the response. Then it waits for a series of *NeighborhoodSharedProfileUpdateRequest* messages, 
to which it replies with corresponding *NeighborhoodSharedProfileUpdateResponse* messages, up until 
the test receives information about all the test identities.

Then it waits for *FinishNeighborhoodInitializationRequest* message and replies with corresponding 
*FinishNeighborhoodInitializationResponse* message.


###### Step 3:

The test creates 5 more identities, establishes hosting agreements with the profile server for them 
and initializes their profiles. 

Then it waits up to 12 minutes while waiting for updates from the profile server.


##### Acceptance Criteria



###### Step 1:

The test successfully obtains list of ports on which the profile server provides its services. 
Then the test successfully establishes hosting agreements for its test identities.
Then the test successfully initializes all test profiles. 


###### Step 2:

Then the test successfully verifies its identity.

Server replies with *StartNeighborhoodInitializationResponse*:
  
  * `Message.id == 3`
  * `Response.status == STATUS_OK`


Server sends a series of *NeighborhoodSharedProfileUpdateRequest* messages with information about hosted profiles.

Server sends *FinishNeighborhoodInitializationRequest*.


###### Step 3:

The test successfully establishes hosting agreements for the new test identities.
Then the test successfully initializes all new profiles. 

The simulated profile server received neighborhood updates in form of *NeighborhoodSharedProfileUpdateRequest* 
for all the new profiles registered on the target profile server. 

